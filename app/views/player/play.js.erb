function sm2_perform_action (action_name) {
  switch(action_name) {
      case 'pause':
          soundManager.pause('mix');
          break;
      case 'resume':
          soundManager.resume('mix');
          break;
      default:
          alert("Unspecifed SM2 action.");
  }
}
function hide_big_and_sm_play_btn () {
  $("#play-btn").hide(0);
  $("#play-btn-lg").hide(0);
}
function reveal_player_container () {
  $("#music_player").attr('play-state', 'playing');
  $("#track-name").html("<%= @track_info[:track_name] %>");
  $("#performer").html("<%= @track_info[:performer] %>");
  $("#album-name").html("專輯: <%= @track_info[:release_name] %>");
  $("#year").html("年份: <%= @track_info[:year] %>");
  $("#music_player_container").slideDown(300,'swing',function() {
    // Action after player control show up.
  });
}
function create_sm2_with_audio_url (audio_url) {
  return soundManager.createSound({
    url: audio_url,
    id: 'mix',
    volume: 100,
    autoPlay: true,
    onload: function () {
//      alert("SM2 onload event detected.");
    },
    whileloading: function () {
//      alert('sound '+this.id+' loading, '+this.bytesLoaded+' of '+this.bytesTotal);
    },
    onplay: function () {
      hide_big_and_sm_play_btn();
      $("#music_player").attr('mix-id', "<%= @mix_id %>")
    },
    onfinish: function(){
      // TODO: call next track
      // curl http://8tracks.com/sets/111696185/next.json?mix_id=14
      $("#music_player_container").slideUp(300, 'swing'); // swing or linear
      $("#play-btn-lg").fadeIn(300);
      $("#music_player").attr('play-state', 'stop');
    },
    whileplaying: function  () {
      var progress = ( (parseInt(this.position) / parseInt(this.duration)) * 100 ).toString();
      $("#duration-runner").css('width', progress + '%');
    },
    ontimeout: function(status){
      alert('SM2 failed to start. Flash missing, blocked or security error?');
      alert('The status is ' + status.success + ', the error type is ' + status.error.type);
    }
  });
}
function delete_previous_sm2_and_create_new_one_fron_audio_stream_url (url) {
  if (soundManager.getSoundById('mix')){ 
    soundManager.destroySound('mix');
    create_sm2_with_audio_url(url);
  } else {
    create_sm2_with_audio_url(url);
  }
}
function bind_control_action () {
  $("#pause-btn").on('click', function () {
    sm2_perform_action('pause');
    $(this).hide(0);
    $("#play-btn").show(0);
  })

  $("#play-btn").on('click', function(){
    sm2_perform_action('resume');
    $(this).hide(0);
    $("#pause-btn").show(0);
  });
  $("#volumn-control").hover(function() {
    /* Stuff to do when the mouse enters the element */
    $("#hidden-bg").fadeIn(200);
    $(".glyphicon-volume-up").fadeTo(200, 1, 'linear');
  }, function() {
    /* Stuff to do when the mouse leaves the element */
    $("#hidden-bg").delay(1000).fadeOut(200);
    $(".glyphicon-volume-up").delay(1000).fadeTo(200, 0.5, 'linear');
  });
}
reveal_player_container();
bind_control_action();
delete_previous_sm2_and_create_new_one_fron_audio_stream_url("<%= @track_info[:audio_stream_url] %>");
